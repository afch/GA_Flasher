//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop

#include "Unit1.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.dfm"
TGRA_AND_AFCH_FLASHER *GRA_AND_AFCH_FLASHER;
//---------------------------------------------------------------------------
__fastcall TGRA_AND_AFCH_FLASHER::TGRA_AND_AFCH_FLASHER(TComponent* Owner)
	: TForm(Owner)
{
}
//---------------------------------------------------------------------------

void __fastcall TGRA_AND_AFCH_FLASHER::FlashButtonClick(TObject *Sender)
{
ShowMessage("!");
}
//---------------------------------------------------------------------------

void __fastcall TGRA_AND_AFCH_FLASHER::Timer1Timer(TObject *Sender)
{
int curItem;

curItem = COMPortComboBox->ItemIndex;
GetComPorts(COMPortComboBox->Items, "COM");

COMPortComboBox->ItemIndex = curItem;
}
//---------------------------------------------------------------------------

void __fastcall TGRA_AND_AFCH_FLASHER::GetComPorts(TStrings *aList, String aNameStart)
{
  TCHAR vBuf[65535];
  int vRes;
  int vErr;
  int vBufSize;
  int vNameStartPos;
  String vName;

  vBufSize = 1024 * 5;
  vRes = 0;

  while (vRes == 0)
	{
	 // setlength(vBuf, vBufSize) ;
	  //vBuf = new CHAR[vBufSize];
	  SetLastError(ERROR_SUCCESS);
	  vRes = QueryDosDevice(NULL, vBuf, vBufSize);
	  vErr = GetLastError();

	  //for 2000
	  if ((vRes != 0) && (vErr == ERROR_INSUFFICIENT_BUFFER))
		{
		  vBufSize = vRes;
		  vRes = 0;
		};

	  if ((vRes == 0) && (vErr == ERROR_INSUFFICIENT_BUFFER))
		{
		  vBufSize = vBufSize + 1024;
		};

	  if ((vErr != ERROR_SUCCESS) && (vErr != ERROR_INSUFFICIENT_BUFFER))
		{
		  throw Exception(SysErrorMessage(vErr));
		}
	};
  //setlength(vBuf, vRes) ;

  vNameStartPos = 1;
  vName = GetNextSubstring(vBuf, vNameStartPos);

  aList->BeginUpdate();
  try
  {
	aList->Clear();
	while (vName != "")
	  {
		//if (StartsStr(aNameStart, vName)) \
		//if (strncmp(aNameStart->c_str(), vName))
		if (vName.SubString(0, aNameStart.Length()) == aNameStart)
		  aList->Add(vName);
		vName = GetNextSubstring(vBuf, vNameStartPos);
	  }
  }
  // catch(const Exception& e){int i=0;}
  __finally
  {
	aList->EndUpdate();
  };
}

String __fastcall TGRA_AND_AFCH_FLASHER::GetNextSubstring(String aBuf, int aStartPos)
{
  int vLastPos;
  String Result;

  if (aStartPos < 1) throw ERangeError("aStartPos must be greate then 0");


  if (aStartPos > aBuf.Length() )
	{
	  return "";
	}

  vLastPos = PosEx(0, aBuf, aStartPos);
  Result = Copy(aBuf, aStartPos, vLastPos - aStartPos);
  aStartPos = aStartPos + (vLastPos - aStartPos) + 1;
  return Result;
}
